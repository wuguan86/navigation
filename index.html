<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI魔方视界导航站</title>
    <style>
        /* Basic Reset & Root Variables */
        :root {
            /* Light Mode */
            --bg-color-light: #eef1f5; /* Fallback */
            --text-color-light: #333;
            --text-secondary-light: #666;
            --title-color-light: #4a69bd;
            --container-bg-light: rgba(255, 255, 255, 0.85);
            --nav-bg-light: #4a69bd;
            --nav-text-light: #ffffff;
            --nav-hover-bg-light: rgba(255, 255, 255, 0.2);
            --nav-active-bg-light: rgba(255, 255, 255, 0.3);
            --card-bg-light: #ffffff;
            --card-shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
            --link-color-light: #4a69bd;
            --footer-text-light: #888;
            --switch-bg-light: #ccc;
            --switch-knob-light: #fff;
            --backdrop-blur-light: blur(8px);
            --scrollbar-thumb-light: rgba(0, 0, 0, 0.2);
            --scrollbar-track-light: rgba(0, 0, 0, 0.05);
            --icon-fallback-bg-light: #eee;
            --icon-fallback-border-light: #ccc;
            --icon-default-svg-light: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM4ODgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1saW5rIj48cGF0aCBkPSJNMTAgMTNhMSAxIDAgMCAwIDEgMWgyYTEgMSAwIDAgMCAxLTFoMXYtMWExIDEgMCAwIDAgLTEtMWgtMmExIDEgMCAwIDAgLTEgMWgtMXYxWiIvPjxwYXRoIGQ9Ik05IDE4djFhNS4wMDUgNS4wMDUgMCAwIDAgNS41MzYtNC43NkExLjUgMS41IDAgMSAxIDE0IDEzIi8+PHBhdGggZD0iTTE0IDZhMSA1LjAwNSA1LjAwNSAwIDAgMC01LjUzNiA0Ljc2QTEuNSAxLjUgMCAxIDEgOSAxMSIvPjwvc3ZnPg==');

            /* Dark Mode */
            --bg-color-dark: #1a1a1a; /* Fallback */
            --text-color-dark: #e0e0e0;
            --text-secondary-dark: #a0a0a0;
            --title-color-dark: #87a1e0;
            --container-bg-dark: rgba(40, 42, 54, 0.85); /* Dracula-ish */
            --nav-bg-dark: #3b508a;
            --nav-text-dark: #f0f0f0;
            --nav-hover-bg-dark: rgba(255, 255, 255, 0.1);
            --nav-active-bg-dark: rgba(255, 255, 255, 0.15);
            --card-bg-dark: #282a36; /* Dracula bg */
            --card-shadow-dark: 0 4px 15px rgba(0, 0, 0, 0.3);
            --link-color-dark: #87a1e0;
            --footer-text-dark: #777;
            --switch-bg-dark: #555;
            --switch-knob-dark: #ccc;
            --backdrop-blur-dark: blur(10px);
            --scrollbar-thumb-dark: rgba(255, 255, 255, 0.2);
            --scrollbar-track-dark: rgba(255, 255, 255, 0.05);
            --icon-fallback-bg-dark: #555;
            --icon-fallback-border-dark: #777;
            --icon-default-svg-dark: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNiYmIiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1saW5rIj48cGF0aCBkPSJNMTAgMTNhMSAxIDAgMCAwIDEgMWgyYTEgMSAwIDAgMCAxLTFoMXYtMWExIDEgMCAwIDAgLTEtMWgtMmExIDEgMCAwIDAgLTEgMWgtMXYxWiIvPjxwYXRoIGQ9Ik05IDE4djFhNS4wMDUgNS4wMDUgMCAwIDAgNS41MzYtNC43NkExLjUgMS41IDAgMSAxIDE0IDEzIi8+PHBhdGggZD0iTTE0IDZhMSA1LjAwNSA1LjAwNSAwIDAgMC01LjUzNiA0Ljc2QTEuNSAxLjUgMCAxIDEgOSAxMSIvPjwvc3ZnPg==');


            /* Default Assignments (Light) */
            --bg-color: var(--bg-color-light);
            --text-color: var(--text-color-light);
            --text-secondary: var(--text-secondary-light);
            --title-color: var(--title-color-light);
            --container-bg: var(--container-bg-light);
            --nav-bg: var(--nav-bg-light);
            --nav-text: var(--nav-text-light);
            --nav-hover-bg: var(--nav-hover-bg-light);
            --nav-active-bg: var(--nav-active-bg-light);
            --card-bg: var(--card-bg-light);
            --card-shadow: var(--card-shadow-light);
            --link-color: var(--link-color-light);
            --footer-text: var(--footer-text-light);
            --switch-bg: var(--switch-bg-light);
            --switch-knob: var(--switch-knob-light);
            --backdrop-blur: var(--backdrop-blur-light);
            --scrollbar-thumb: var(--scrollbar-thumb-light);
            --scrollbar-track: var(--scrollbar-track-light);
            --icon-fallback-bg: var(--icon-fallback-bg-light);
            --icon-fallback-border: var(--icon-fallback-border-light);
            --icon-default-svg: var(--icon-default-svg-light);


             /* Define fixed height for content area */
             --content-panel-height: 50vh; /* Example: 50% of viewport height */
        }

        body.dark-mode {
            --bg-color: var(--bg-color-dark);
            --text-color: var(--text-color-dark);
            --text-secondary: var(--text-secondary-dark);
            --title-color: var(--title-color-dark);
            --container-bg: var(--container-bg-dark);
            --nav-bg: var(--nav-bg-dark);
            --nav-text: var(--nav-text-dark);
            --nav-hover-bg: var(--nav-hover-bg-dark);
            --nav-active-bg: var(--nav-active-bg-dark);
            --card-bg: var(--card-bg-dark);
            --card-shadow: var(--card-shadow-dark);
            --link-color: var(--link-color-dark);
            --footer-text: var(--footer-text-dark);
            --switch-bg: var(--switch-bg-dark);
            --switch-knob: var(--switch-knob-dark);
            --backdrop-blur: var(--backdrop-blur-dark);
            --scrollbar-thumb: var(--scrollbar-thumb-dark);
            --scrollbar-track: var(--scrollbar-track-dark);
            --icon-fallback-bg: var(--icon-fallback-bg-dark);
            --icon-fallback-border: var(--icon-fallback-border-dark);
            --icon-default-svg: var(--icon-default-svg-dark);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            line-height: 1.6;
            background-image: url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80'); /* Example background */
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            background-color: var(--bg-color); /* Added fallback bg color */
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s, color 0.3s;
        }

        .main-container {
            width: 100%;
            max-width: 1280px;
            background-color: var(--container-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
            flex-shrink: 0;
        }

        header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--title-color);
            margin-bottom: 5px;
            transition: color 0.3s;
        }

        header p {
            font-size: 1rem;
            color: var(--text-secondary);
            transition: color 0.3s;
        }

        /* Theme Switch */
        .theme-switch-wrapper {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            background-color: rgba(128, 128, 128, 0.1);
            padding: 5px 8px;
            border-radius: 20px;
            z-index: 10;
        }
        .theme-switch-wrapper label {
             font-size: 0.8rem;
             color: var(--text-secondary);
             margin-right: 5px;
             cursor: pointer;
        }
        .theme-switch {
            display: inline-block;
            height: 20px;
            position: relative;
            width: 40px;
        }
        .theme-switch input { display:none; }
        .slider {
            background-color: var(--switch-bg);
            bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 20px;
        }
        .slider:before {
            background-color: var(--switch-knob);
            bottom: 2px; content: ""; height: 16px; left: 2px; position: absolute; transition: .4s; width: 16px; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--link-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Category Navigation */
        .category-nav {
            background-color: var(--nav-bg);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px 15px;
            justify-content: flex-start;
            transition: background-color 0.3s;
            flex-shrink: 0;
        }

        .category-button {
            color: var(--nav-text);
            background-color: transparent;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: background-color 0.2s ease-in-out, color 0.2s;
            white-space: nowrap;
        }

        .category-button:hover {
            background-color: var(--nav-hover-bg);
        }

        .category-button.active {
            background-color: var(--nav-active-bg);
            font-weight: 600;
        }

        .category-button img.cat-icon {
            width: 18px;
            height: 18px;
             /* Default white filter */
             filter: invert(100%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(150%) contrast(100%);
             transition: filter 0.3s;
        }
         body.dark-mode .category-button img.cat-icon {
             /* Slightly adjusted for dark mode if needed, current white is often good */
             filter: invert(90%) sepia(10%) saturate(100%) hue-rotate(180deg) brightness(100%) contrast(90%);
        }

        /* Content Area */
        .content-panels {
             height: var(--content-panel-height);
             overflow-y: auto;
             padding: 10px 5px 10px 0;
             position: relative;
             flex-grow: 1;
             /* Custom Scrollbar */
             scrollbar-width: thin; /* Firefox */
             scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track); /* Firefox */
        }
        .content-panels::-webkit-scrollbar {
            width: 8px;
        }
        .content-panels::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 4px;
        }
        .content-panels::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb);
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .content-panels::-webkit-scrollbar-thumb:hover {
            background-color: var(--link-color);
        }

        .content-panels .panel {
             display: none;
        }
        .content-panels .panel.active {
             display: block;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            padding-right: 10px; /* Space for scrollbar */
        }

        .link-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 18px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--text-color);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, background-color 0.3s;
            overflow: hidden;
        }

        .link-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
         body.dark-mode .link-card:hover {
             box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
         }

        .card-icon-container {
             flex-shrink: 0;
             margin-right: 15px;
             width: 32px;
             height: 32px;
             display: flex;
             align-items: center;
             justify-content: center;
             border-radius: 6px;
        }

        .card-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
            border-radius: 4px;
            display: block; /* Prevents potential extra space */
        }

        .card-icon-default { /* Fallback span */
             display: inline-block;
             width: 24px;
             height: 24px;
             background-color: var(--icon-fallback-bg);
             border: 1px solid var(--icon-fallback-border);
             border-radius: 5px;
             flex-shrink: 0;
             background-image: var(--icon-default-svg);
             background-size: 16px 16px; /* SVG size */
             background-repeat: no-repeat;
             background-position: center center;
             transition: background-color 0.3s, border-color 0.3s, background-image 0.3s;
        }

        .card-text-content {
            flex-grow: 1;
            min-width: 0;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 3px;
            color: var(--text-color);
            word-break: break-word;
             transition: color 0.3s;
             display: block;
        }

        .card-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            word-break: break-word;
             transition: color 0.3s;
             display: block; /* Ensure it takes full width */
             margin-top: 2px; /* Add slight space */
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(128, 128, 128, 0.2);
            font-size: 0.85rem;
            color: var(--footer-text);
             transition: color 0.3s, border-color 0.3s;
            flex-shrink: 0;
        }
        footer a {
            color: var(--link-color);
            text-decoration: none;
             transition: color 0.3s;
        }
        footer a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 992px) {
             .content-grid {
                 grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
             }
             /* :root { --content-panel-height: 45vh; } */
        }
        @media (max-width: 768px) {
             body {
                 padding: 10px;
                 align-items: flex-start;
             }
            .main-container {
                padding: 20px;
                 max-height: 95vh;
                 overflow: hidden;
            }
            header h1 { font-size: 1.8rem; }
            header p { font-size: 0.9rem; }
            .category-nav {
                 padding: 8px;
                 gap: 5px 10px; /* Adjusted gaps */
            }
            .category-button { font-size: 0.85rem; padding: 6px 10px; }
             .content-grid {
                 gap: 15px;
                 grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* Adjust for smaller cards */
             }
             .link-card { padding: 15px; }
             .card-title { font-size: 0.95rem; }
             .card-description { font-size: 0.75rem; }
             .theme-switch-wrapper { top: 15px; right: 15px; }
             footer { font-size: 0.8rem; }
             /* :root { --content-panel-height: 40vh; } */
        }
         @media (max-width: 480px) {
             header h1 { font-size: 1.5rem; }
             .category-nav {
                justify-content: flex-start;
                overflow-x: auto;
                flex-wrap: nowrap;
                /* Use padding for scrollbar space */
                padding: 8px 8px 15px 8px; /* Add bottom padding */
                margin-bottom: 15px; /* Reduce margin */
                /* Custom Scrollbar for nav */
                scrollbar-width: thin;
                scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
             }
             .category-nav::-webkit-scrollbar {
                 height: 6px;
             }
              .category-nav::-webkit-scrollbar-track {
                 background: var(--scrollbar-track);
                 border-radius: 3px;
             }
              .category-nav::-webkit-scrollbar-thumb {
                 background-color: var(--scrollbar-thumb);
                 border-radius: 3px;
             }
             .category-button { flex-shrink: 0; }
              .content-grid {
                 grid-template-columns: 1fr; /* Single column */
             }
             .link-card {
                 flex-direction: row;
                 text-align: left;
             }
             .card-icon-container { margin-right: 10px; }
             .theme-switch-wrapper { top: 10px; right: 10px; }
             footer { margin-top: 20px; padding-top: 15px;}
             /* :root { --content-panel-height: 55vh; } /* Maybe more height needed for single column */
         }

    </style>
</head>
<body>

    <div class="main-container">

        <div class="theme-switch-wrapper">
            <label for="checkbox">Dark:</label>
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox" />
                <div class="slider round"></div>
            </label>
        </div>

        <header>
            <h1>AI魔方视界导航站</h1>
            <p>精心整理的AI工具与资源</p>
        </header>

        <nav class="category-nav">
            <!-- Category buttons will be generated here -->
        </nav>

        <div class="content-panels">
            <!-- Content panels will be generated here -->
        </div>

        <footer>
            © 2025 AI工具书签收藏 <br>
            最后更新: <span id="last-updated-date">2025-04-09</span> <br> <!-- Use span for dynamic date -->
            设计与开发: <a href="#" target="_blank" rel="noopener noreferrer">AI魔方视界</a>
        </footer>
    </div>

    <!-- Load data first -->
    <script src="data.js"></script>

    <!-- Then load the main script -->
    <script>
        // Ensure data from data.js is loaded before running this
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM Elements ---
            const categoryNav = document.querySelector('.category-nav');
            const contentPanelsContainer = document.querySelector('.content-panels');
            const themeToggle = document.getElementById('checkbox');
            const lastUpdatedSpan = document.getElementById('last-updated-date'); // Get the span

            // --- Helper Function to Create Link Card ---
            function createLinkCardElement(link) {
                const card = document.createElement('a');
                card.className = 'link-card';
                card.href = link.href;
                card.target = '_blank';
                card.rel = 'noopener noreferrer';
                card.title = `${link.text}${link.description ? ' - ' + link.description : ''}`;

                const iconContainer = document.createElement('div');
                iconContainer.className = 'card-icon-container';

                const fallbackIcon = document.createElement('span');
                fallbackIcon.className = 'card-icon-default';

                if (link.icon) {
                    const icon = document.createElement('img');
                    icon.className = 'card-icon';
                    icon.src = link.icon;
                    icon.alt = ""; // Decorative
                    icon.loading = 'lazy'; // Lazy load images
                    icon.onerror = function() {
                        // Check if the icon is still the child before replacing
                        if (icon.parentNode === iconContainer) {
                           iconContainer.replaceChild(fallbackIcon, icon);
                        }
                    };
                    iconContainer.appendChild(icon);
                } else {
                    iconContainer.appendChild(fallbackIcon);
                }

                card.appendChild(iconContainer);

                const textContent = document.createElement('div');
                textContent.className = 'card-text-content';

                const title = document.createElement('span');
                title.className = 'card-title';
                title.textContent = link.text;
                textContent.appendChild(title);

                if (link.description) {
                    const description = document.createElement('span');
                    description.className = 'card-description';
                    description.textContent = link.description;
                    textContent.appendChild(description);
                }

                card.appendChild(textContent);

                return card;
            }

            // --- Helper Function to Create Panel Content (Grid) using DocumentFragment ---
            function createPanelContent(items) {
                const grid = document.createElement('div');
                grid.className = 'content-grid';

                if (items && items.length > 0) {
                    const fragment = document.createDocumentFragment(); // Use DocumentFragment
                    items.forEach(link => {
                        fragment.appendChild(createLinkCardElement(link));
                    });
                    grid.appendChild(fragment); // Append fragment once
                } else {
                    const placeholder = document.createElement('p');
                    placeholder.style.textAlign = 'center';
                    placeholder.style.color = 'var(--text-secondary)';
                    placeholder.style.padding = '20px';
                    placeholder.textContent = '此分类下暂无书签';
                    grid.appendChild(placeholder);
                }
                return grid;
            }

            // --- Function to Build UI ---
            function buildUI(data) {
                 // Clear existing content first
                 categoryNav.innerHTML = '';
                 contentPanelsContainer.innerHTML = '';

                // Determine the initial category name dynamically
                let firstCategoryName = '';
                const topLevelKeys = Object.keys(data);

                if (data["书签栏"] && data["书签栏"].folders && Object.keys(data["书签栏"].folders).length > 0) {
                    // If bookmark bar has folders, pick the first one alphabetically
                    firstCategoryName = Object.keys(data["书签栏"].folders).sort()[0];
                } else if (topLevelKeys.length > 0) {
                     // Otherwise, pick the first top-level key alphabetically
                    firstCategoryName = topLevelKeys.sort()[0];
                }

                const categoriesToAdd = [];

                // Process Bookmarks Bar Folders first
                if (data["书签栏"] && data["书签栏"].folders) {
                    const sortedFolderNames = Object.keys(data["书签栏"].folders); // Sort alphabetically
                    sortedFolderNames.forEach(folderName => {
                        if (data["书签栏"].folders[folderName] && data["书签栏"].folders[folderName].length > 0) { // Check if folder has links
                            categoriesToAdd.push({
                                name: folderName,
                                links: data["书签栏"].folders[folderName],
                                isActive: folderName === firstCategoryName
                            });
                        }
                    });
                }

                // Process any other top-level categories (like 'AI模型', etc., if they weren't under '书签栏')
                // This part might not be needed if *everything* is under "书签栏" -> "folders"
                 topLevelKeys.forEach(categoryName => {
                     if (categoryName !== "书签栏") { // Avoid reprocessing bookmark bar itself
                        const categoryData = data[categoryName];
                         // Assuming top-level categories directly contain links or are structured like '书签栏'
                         const links = categoryData.links || (categoryData.folders ? [] : categoryData); // Adjust based on your *actual* data structure for top-level items if different

                         // Only add if it has links and hasn't been added already (e.g., if it was also a folder name)
                         if (links && links.length > 0 && !categoriesToAdd.some(cat => cat.name === categoryName)) {
                              categoriesToAdd.push({
                                 name: categoryName,
                                 links: links,
                                 isActive: categoryName === firstCategoryName
                             });
                         }
                         // If top-level categories can *also* have folders like '书签栏', add logic here too
                     }
                 });


                // Now add all collected categories to the UI
                categoriesToAdd.forEach(catInfo => {
                    addCategory(catInfo.name, catInfo.links, catInfo.isActive);
                });

                // Add click listeners AFTER all buttons are added
                addTabSwitchingLogic();

                // Set dynamic date
                 if(lastUpdatedSpan) {
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-based
                    const dd = String(today.getDate()).padStart(2, '0');
                    lastUpdatedSpan.textContent = `${yyyy}-${mm}-${dd}`;
                 }
            }


            // --- Helper to add category button and panel ---
            function addCategory(categoryName, links, makeActive) {
                // Create Category Button
                const button = document.createElement('button');
                button.className = 'category-button';
                const panelId = `panel-${categoryName.replace(/\s+/g, '-')}`;
                button.dataset.target = panelId;

                // Add Icon to Button
                const catIcon = document.createElement('img');
                catIcon.className = 'cat-icon';
                // Use specific icon or fallback to "Other" or default link icon
                catIcon.src = categoryIcons[categoryName] || categoryIcons["其他工具"] || defaultBookmarkFavicon;
                catIcon.alt = ""; // Decorative
                catIcon.loading = 'lazy'; // Lazy load icons
                 catIcon.onerror = function() { // Fallback for category icons too
                     if(catIcon.src !== defaultBookmarkFavicon) { // Avoid infinite loop if default fails
                         catIcon.src = defaultBookmarkFavicon;
                     }
                 };
                button.appendChild(catIcon);

                // Add Text to Button
                const buttonText = document.createTextNode(categoryName);
                button.appendChild(buttonText);

                categoryNav.appendChild(button);

                // Create Panel
                const panel = document.createElement('div');
                panel.className = 'panel';
                panel.id = panelId;
                panel.appendChild(createPanelContent(links));
                contentPanelsContainer.appendChild(panel);

                // Activate the designated first category
                if (makeActive) {
                    button.classList.add('active');
                    panel.classList.add('active');
                }
            }

             // --- Add event listeners for tab switching ---
            function addTabSwitchingLogic() {
                const buttons = categoryNav.querySelectorAll('.category-button');
                buttons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault(); // Prevent potential default anchor behavior if wrapped later

                        // Deactivate all
                        buttons.forEach(btn => btn.classList.remove('active'));
                        contentPanelsContainer.querySelectorAll('.panel').forEach(pnl => pnl.classList.remove('active'));

                        // Activate clicked
                        button.classList.add('active');
                        const targetPanelId = button.dataset.target;
                        const targetPanel = document.getElementById(targetPanelId);
                        if (targetPanel) {
                            targetPanel.classList.add('active');
                             // Scroll content panel to top when switching tabs
                             contentPanelsContainer.scrollTop = 0;
                        } else {
                            console.warn(`Panel with ID ${targetPanelId} not found.`);
                        }
                    });
                });
            }

            // Theme Toggle Logic
            function applyTheme(isDark) {
                document.body.classList.toggle('dark-mode', isDark);
                 // Update default icon based on theme for cards created dynamically
                 // Note: This relies on CSS variables for the actual icon change.
                 // The JS update might be redundant if CSS handles it, but good for explicit control.
                 // For existing icons, CSS will handle it via the body class.
            }

            themeToggle.addEventListener('change', () => {
                const isDark = themeToggle.checked;
                applyTheme(isDark);
                localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
            });

            // Check for saved theme preference on load
            // Use prefers-color-scheme as fallback
            const savedTheme = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'enabled' || (savedTheme === null && prefersDark)) {
                themeToggle.checked = true;
                applyTheme(true);
            } else {
                themeToggle.checked = false;
                applyTheme(false);
            }

            // Initial UI Build
            // Check if data exists before building
            if (typeof bookmarksData !== 'undefined' && typeof categoryIcons !== 'undefined') {
                 buildUI(bookmarksData);
            } else {
                console.error("Bookmark data or icons not loaded from data.js!");
                // Optionally display an error message to the user
                contentPanelsContainer.innerHTML = "<p style='color: red; text-align: center; padding: 20px;'>错误：无法加载书签数据。</p>";
            }
        });

    </script>

</body>
</html>